#include "uart_comm_fsm.h"
#include "main.h"
#include <stdio.h>
#include <string.h>
#include <stdint.h>

extern UART_HandleTypeDef huart2;
extern ADC_HandleTypeDef  hadc1;

extern uint8_t command_flag;
extern uint32_t adcValue;
extern volatile uint8_t frame_ready;
extern uint8_t buffer[];
extern uint8_t buffer_index;

static uint8_t waiting_ack = 0;
static uint32_t deadline_ms = 0;
static char last_packet[32];

void uart_communicate_fsm(void){
  if (command_flag == 1 && waiting_ack == 0){
    HAL_ADC_Start(&hadc1);
    HAL_ADC_PollForConversion(&hadc1, 10);
    adcValue = HAL_ADC_GetValue(&hadc1);
    HAL_ADC_Stop(&hadc1);

    snprintf(last_packet, sizeof(last_packet), "!ADC=%lu#\r\n", (unsigned long)adcValue);
    HAL_UART_Transmit(&huart2, (uint8_t*)last_packet, strlen(last_packet), 100);
    waiting_ack = 1;
    deadline_ms = HAL_GetTick() + 3000;
    command_flag = 0;
  }

  if (command_flag == 2 && waiting_ack == 1){
    waiting_ack = 0;
    command_flag = 0;
  }

  if (waiting_ack && (int32_t)(HAL_GetTick() - deadline_ms) >= 0){
    HAL_UART_Transmit(&huart2, (uint8_t*)last_packet, strlen(last_packet), 100);
    deadline_ms = HAL_GetTick() + 3000;
  }
}
